<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Dispatchr Backbone Source: service/service.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.Spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Dispatchr Backbone</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="BackboneClient.html">BackboneClient</a></li><li><a href="BackboneClientMessage.html">BackboneClientMessage</a></li><li><a href="BackboneService.html">BackboneService</a></li><li><a href="CmdService.html">CmdService</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: service/service.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">"use strict";
/**
 * @fileoverview This is is a generic broker woker api for javascript
 */
var zmq = require('zmq'); //https://github.com/JustinTulloss/zeromq.node/blob/master/README.md
var _ = require('underscore');

const HB_INTERVAL = 1000;  // in milliseconds
const HB_LIVENESS = 3;     // HBs to miss before connection counts as dead

const PROTO_VERSION = 'MDPW01';  //MajorDomo Protocol Woker 1

const MESSAGE_READY      = '\x01';
const MESSAGE_REQUEST    = '\x02';
const MESSAGE_REPLY      = '\x03';
const MESSAGE_HEARTBEAT  = '\x04';
const MESSAGE_DISCONNECT = '\x05';


/**
 * This function is called whenever the service recieves a message.
 * @callback BackboneService~on_request
 * @param {String|Array}                 message   Message Array
 * @param {BackboneService~reply} reply     Reply callback
 */

/**
 * This callback is sent with the message as a way to reply to the message
 * @callback BackboneService~reply
 * @param {String|Array} message         Message Array to be sent as reply to request.
 */


class BackboneService {
  /**
   * @constructor
   * @param {String}                    service      name of the service
   * @param {BackboneService~on_request} on_request - The callback that handles the response.
   * @param {Object}                    options 
   * @param {String}                    options.host host to connect to backbone
   * @param {String}                    options.port port to connect to backbone
   */  
  constructor(service, on_request, options) {
    options = options || {};
    this.host = options.host || '127.0.0.1';
    this.port = options.port || "5555";
    this.service = service;
    this.on_request = on_request;
    this.stream = null;
    this._tmo = null;
    this.need_handshake = true;
    this.ticker = null;
    this._delayed_cb = null;
    
    var self = this;
    var endpoint = this.getEndpoint();
    this._socket = zmq.socket('dealer');
    this._socket.monitor(500, 0);    
    this._socket.on('message', function(){
      var args = _.map(arguments, msgbuf => msgbuf);
      self._on_message(args);
    });    
    this._socket.on('connect', function(){
      console.log("Connected: ", endpoint);
    });    
    this._socket.on('disconnect', function(){
      console.log("Disconnected:  ", endpoint);
    });
  }
  
  getEndpoint() {
    return `tcp://${this.host}:${this.port}`;
  }
  
  /**
   * @function
   * @memberof BackboneService
   * @instance
   * @description Connect service to backbon
   */
  connect(){
    var self = this;    
    var endpoint = this.getEndpoint();
    console.log("Registering Service", this.service);
    this._socket.connect(endpoint);    
    this._send_ready();
    this.ticker = setInterval(function() {
      self._tick();
    }, HB_INTERVAL);

  }
  
  _send_ready() {
    var ready_msg = [ '', PROTO_VERSION, MESSAGE_READY, this.service ];
    this._socket.send(ready_msg);
    this.curr_liveness = HB_LIVENESS;
  }
  
  
  _tick(){
    var self = this;
    this.curr_liveness -= 1;
    // console.log('%.3f tick - %d' % (time.time(), self.curr_liveness);
    this.send_heartbeat();
    if(this.curr_liveness &lt; 0){
      console.log('Connection Lost');
      // ouch, connection seems to be dead
      this.shutdown();
      // try to recreate it
      this._delayed_cb = setTimeout(function() {
        self.connect();
      }, 5000);
    }
  }

  send_heartbeat(){
    var msg = [ '', PROTO_VERSION, '\x04' ];
    this._socket.send(msg);
  }
  
  shutdown() {
    if(this.ticker){
      clearInterval(this.ticker);
      this.ticker = null;
      if(this.stream) {
        this._socket.close();
        this.timed_out = false;
        this.need_handshake = true;
        this.connected = true;
      }
    }
  }
  
  reply(envelope, msg){
    // if self.need_handshake:
    //   raise ConnectionNotReadyError()
    // prepare full message
    var to_send = envelope;
    if(Array.isArray(msg)) {
      to_send.push.apply(to_send, msg);
    } else {
      to_send.push(msg);
    }
    console.log("REPLY", envelope, msg);
    this._socket.send(to_send);
  }
  
  _on_message(msg) {
    var self = this;
    
    // 1st part is empty
    msg.shift();
    // 2nd part is protocol version
    // TODO: version check
    var protocol = msg.shift();
    if(protocol.toString() !== PROTO_VERSION) {
      console.error("PROTCOL VERSION MISSMATCH", protocol, PROTO_VERSION);
    } else {      
      // 3rd part is message type
      var msg_type = msg.shift().toString();
       // XXX: hardcoded message types!
       // any message resets the liveness counter
      this.need_handshake = false;
      this.curr_liveness = HB_LIVENESS;
      
      if(msg_type === MESSAGE_DISCONNECT){ // disconnect
        this.curr_liveness = 0; // reconnect will be triggered by hb timer
      } else if(msg_type === MESSAGE_REQUEST){// # request
        // remaining parts are the user message
        var split = split_address(msg);
        var envelope = split[0];
        msg = split[1];
        envelope.push('');
        envelope = [ '', PROTO_VERSION, MESSAGE_REPLY].concat(envelope); // REPLY
        msg = _.each(msg, item => item.toString());
        this.on_request(msg, function(reply_msg){          
          self.reply(envelope, reply_msg);
        });
      } else if(msg_type !== MESSAGE_HEARTBEAT) {
        console.error("Unknown Message Type", msg_type);
      } 
    }
  }
}


function split_address(msg) {
  var ret_ids = [];
  for(var i = 0; i &lt; msg.length; i++) {
    var p = msg[i];
    if (p.length !== 0) {
      ret_ids.push(p);
    } else {
      break;
    }
  }
  return [ret_ids, msg.slice(i+1)];
}

module.exports = BackboneService;


</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on 2016-11-17T16:42:08-08:00
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
