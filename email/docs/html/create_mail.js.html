<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>create_mail.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-email_create_mail.html">email/create_mail</a><ul class='methods'><li data-type='method'><a href="module-email_create_mail.html#~create_email">create_email</a></li><li data-type='method'><a href="module-email_create_mail.html#~generateEmail">generateEmail</a></li></ul></li><li><a href="module-email_google_api_auth.html">email/google_api_auth</a><ul class='methods'><li data-type='method'><a href="module-email_google_api_auth.html#~authorize">authorize</a></li><li data-type='method'><a href="module-email_google_api_auth.html#~createNewToken">createNewToken</a></li><li data-type='method'><a href="module-email_google_api_auth.html#~storeToken">storeToken</a></li></ul></li><li><a href="module-email_service.html">email/service</a><ul class='methods'><li data-type='method'><a href="module-email_service.html#~request">request</a></li><li data-type='method'><a href="module-email_service.html#~request">request</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">create_mail.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @@author &lt;gabe@dispathcr.co> (Gabriel Littman)
 * @module email/create_mail 
 */
var mustache = require("mustache");

var BPromise = require('bluebird');
var fs = BPromise.promisifyAll(require("fs"));
var path = require('path');
var _ = require('underscore');
var send_gmail = require('./send_gmail');



function loadDBTemplate(template_name) {
  var EmailTemplate = require('dsp_shared/database/model/email/template'); 
  return EmailTemplate.findAll({template_name: template_name}).then(templates => {
    var tmpl = {body: {}};
    for(var i = 0; i &lt; templates.length; i++) {
      tmpl.subject = templates[i].subject;
      tmpl.body[templates[i].body_type] = templates[i].body;
    }
    console.log("TEMPLATE", tmpl);
    return tmpl;
  });
}


function loadFileTemplate(template_name) {
  return fs.readFileAsync(path.dirname(__filename)+"/templates/"+template_name+".json").then(data => {
    return JSON.parse(data);
  });
}


function loadDBDistList(name) {
  var DistList = require('dsp_shared/database/model/email/distribution_list'); 
  return DistList.findAll({list_name: name}).then(emails => {
    var list = [];
    for(var i = 0; i &lt; emails.length; i++) {
      list.push({name: emails[i].name, email: emails[i].email});
    }
    
    return list;
  });
}


function loadFileDistList(name) {
  return fs.readFileAsync(path.dirname(__filename)+"/distribution_lists/"+name+".json").then(data => {
    return JSON.parse(data);
  });
}



function loadTemplate(template_name) {
  return loadFileTemplate(template_name).catch( () => {
    return loadDBTemplate(template_name);
  });
}

function loadDistributionList(name, concat){
  concat = concat || false;
  
  return loadFileDistList(name).catch(()=> {
    return loadDBDistList(name);
  }).then(list => {
    if(!concat) {
      return list;
    } else {
      var out = [];
      for(var i = 0; i &lt; list.length; i++) {
        var item = list[i];
        
        if(item.name) {
          var entry = "";
          entry += item.name;
          entry += `  &lt;${item.email}>`;
          out.push(entry);
        } else {
          out.push(item.email);
        }
      }
      return out.join(', ');
    }
  });
}

function *processTemplate(template, values) {
  var message = {};
  template = yield loadTemplate(template);
  
  if(template.subject) {
    message.subject = mustache.render(template.subject, values);
  }
  
  if(template.body) {
    for(var type in template.body) {
      if(template.body.hasOwnProperty(type))  {
        var body = template.body[type];
        if(values) {
          body = mustache.render(body, values);
        }
        message[type] = body;          
      }
    }
  }
  return message;
}

/**
 * 
 */
function *generateEmail(to, from, template, values, subject, text, html, replyTo, send) {
  var message = {};
  
  message.to = to;
  message.template = template;
  message.values = values;
  message.from = from;    
  message.replyTo = replyTo;
  message.text = text;
  message.html = html;
  message.subject = subject;
  
  return yield create_email(message, send);
}

/**
 * @param {Object}  options            options
 * @param {String}  options.to         email address or distribution list 
 * @param {String}  options.from       from who is the email from
 * @param {String}  options.replyTo    from who should be set as reply to
 * @param {String}  options.template   template name
 * @param {String}  options.subject    email subject, template takes presidence
 * @param {String}  options.text       text email body , template takes presidence
 * @param {String}  options.html       html email body, template takes presidence
 * @param {Boolean} options.send       if ture email will be sent
 * @return {Object} result
 * @return {Object} result.sent        true if email was sent
 * @return {Object} result.error       error message if email not sent
 * @return {Object} result.{other}     other final options used to send email
 */
function *create_email(options, send) {
  
  options.from = options.from || "Dispatchr &lt;no-reply@dispatchr.co>";
  options.replyTo = options.replyTo || options.from;
  
  if(options.template) {
    _.extend(options, yield processTemplate(options.template, options.values));
    delete options.template;
  } 

  if(options.to) {
    if(options.to.indexOf('@') === -1) {
      options.to = yield loadDistributionList(options.to, true);
    }
  }
  
  options.sent = false;
  // console.log("generateEmail", options);
  if(send) {
    return yield send_gmail(options).then((send_response) => {
      options.sent = true;
      options.send_response = send_response;
    }).catch(error => {
      options.sent = false;
      options.error = error;
    });    
  } else {
    options.sent = false;
    options.error = 'Send Not Requested';
  } 
  return options;
}

module.exports = create_email;

if (require.main === module) {
  var baker = require('dsp_shared/lib/baker');  
  var util = require('dsp_shared/lib/cmd_utils');
  util.connect(["postgres"]);
  
  baker.command(generateEmail, {command: "generateEmail", default: true, opts: 'values'});
  baker.run();
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Dec 15 2016 23:39:51 GMT-0800 (PST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
